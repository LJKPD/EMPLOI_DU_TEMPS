<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charges Horaires des Professeurs</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #278cf1 0%, #012d54 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .stats-card {
            background: linear-gradient(45deg, #07c7e4, #048eea);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
         #statistiques {
            display: flex !important;
            flex-wrap: wrap;
        }
        #statistiques .col-lg-3 {
            display: flex;
            margin-bottom: 0;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .detail-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
            transition: transform 0.3s ease;
        }
        .detail-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .prof-name {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1rem;
        }
        .heures {
            color: #28a745;
            font-weight: 600;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #dc3545;
        }
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.6);
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <br><br>
            <h1 class="text-white mb-3">
                <i class="fas fa-chart-bar me-3"></i>
                Charges Horaires des Professeurs
            </h1>
            <p class="text-white-50">Visualisation des heures d'enseignement par professeur</p>
        </div><br>

        <!-- Statistiques générales -->
        <div id="statistiques" class="row mb-4" style="display: none;">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stat-item">
                        <span class="stat-value" id="totalHeures">0</span>
                        <span class="stat-label">Heures totales</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stat-item">
                        <span class="stat-value" id="nbProfesseurs">0</span>
                        <span class="stat-label">Professeurs</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stat-item">
                        <span class="stat-value" id="moyenneHeures">0</span>
                        <span class="stat-label">Moyenne h/prof</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stat-item">
                        <span class="stat-value" id="heuresMax">0</span>
                        <span class="stat-label">Maximum</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Graphique principal -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-column me-2"></i>
                            Répartition des Charges Horaires
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="loadingChart" class="loading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-3">Chargement des données...</p>
                        </div>
                        <div id="errorChart" class="error" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorMessage">Erreur lors du chargement</span>
                        </div>
                        <div class="chart-container">
                            <canvas id="chargesChart" style="display: none;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Détails par professeur -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Détails par Professeur
                        </h5>
                    </div>
                    <div class="card-body" id="detailsProfesseurs" style="max-height: 500px; overflow-y: auto;">
                        <div class="loading">
                            <div class="spinner-border text-success" role="status"></div>
                            <p class="mt-3">Chargement...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bouton de rafraîchissement -->
        <button class="refresh-btn" onclick="chargerDonnees()" title="Actualiser les données">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <script>
        let chart = null;

        // Charger les données au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            chargerDonnees();
        });

        async function chargerDonnees() {
            try {
                // Vérifier que Chart.js est chargé
                if (typeof Chart === 'undefined') {
                    throw new Error('Chart.js n\'est pas chargé correctement');
                }

                // Afficher les indicateurs de chargement
                document.getElementById('loadingChart').style.display = 'block';
                document.getElementById('errorChart').style.display = 'none';
                document.getElementById('chargesChart').style.display = 'none';
                document.getElementById('statistiques').style.display = 'none';

                console.log('Tentative de chargement des données...');
                const response = await fetch('php/get_charges_horaires.php');
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const textResponse = await response.text();
                console.log('Raw response:', textResponse);
                
                let data;
                try {
                    data = JSON.parse(textResponse);
                } catch (jsonError) {
                    console.error('Erreur de parsing JSON:', jsonError);
                    throw new Error('Réponse serveur invalide (pas du JSON valide)');
                }

                if (!data.success) {
                    throw new Error(data.message || 'Erreur dans la réponse du serveur');
                }

                // Masquer le chargement
                document.getElementById('loadingChart').style.display = 'none';

                if (data.data.labels.length === 0) {
                    document.getElementById('errorChart').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'Aucune donnée de charge horaire disponible';
                    return;
                }

                // Afficher le graphique
                document.getElementById('chargesChart').style.display = 'block';
                creerGraphique(data.data);

                // Afficher les statistiques
                afficherStatistiques(data.statistiques);

                // Afficher les détails
                afficherDetails(data.data.labels, data.data.datasets[0].data, data.details);

                console.log('Données chargées avec succès:', data);

            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                document.getElementById('loadingChart').style.display = 'none';
                document.getElementById('errorChart').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        function creerGraphique(data) {
            const ctx = document.getElementById('chargesChart').getContext('2d');

            // Détruire le graphique existant s'il existe
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Heures d\'enseignement par professeur (par semaine)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} heures`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Heures'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + 'h';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Professeurs'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function afficherStatistiques(stats) {
            document.getElementById('totalHeures').textContent = stats.total_heures + 'h';
            document.getElementById('nbProfesseurs').textContent = stats.nb_professeurs;
            document.getElementById('moyenneHeures').textContent = stats.moyenne_heures + 'h';
            document.getElementById('heuresMax').textContent = stats.heures_max + 'h';
            document.getElementById('statistiques').style.display = 'block';
        }

        function afficherDetails(labels, heures, details) {
            const container = document.getElementById('detailsProfesseurs');
            let html = '';

            labels.forEach((prof, index) => {
                const heureProf = heures[index];
                const modules = details.modules[index] || 'Aucun module';
                const nbSeances = details.nb_seances[index] || 0;

                html += `
                    <div class="detail-card">
                        <div class="prof-name">${prof}</div>
                        <div class="heures">
                            <i class="fas fa-clock me-1"></i>
                            ${heureProf} heures/semaine
                        </div>
                        <div class="text-muted small mt-2">
                            <i class="fas fa-chalkboard me-1"></i>
                            ${nbSeances} séance(s)
                        </div>
                        <div class="text-muted small mt-1">
                            <i class="fas fa-book me-1"></i>
                            ${modules}
                        </div>
                    </div>
                `;
            });

            if (html === '') {
                html = '<p class="text-center text-muted">Aucun détail disponible</p>';
            }

            container.innerHTML = html;
        }
    </script>
</body>
</html>